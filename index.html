<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Avaliação SST — Arquivo Único (versão funcional)</title>
<style>
  :root{--muted:#6b7280}
  body{font-family:Arial, Helvetica, sans-serif;background:#f4f6f8;color:#111;margin:0;padding:16px}
  .container{max-width:1100px;margin:0 auto}
  .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:1.25rem}
  nav{margin:12px 0;display:flex;gap:8px}
  button{background:#0b74da;color:white;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
  .muted{color:var(--muted);font-size:0.95rem}
  input, textarea, select{padding:8px;border-radius:6px;border:1px solid #cbd5e1;width:100%;box-sizing:border-box}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .q{padding:10px;border-radius:8px;background:#fbfdff;margin-bottom:10px;border:1px solid #eef2f7}
  label{display:block;margin-bottom:6px}
  .small{font-size:0.9rem;color:var(--muted)}
  #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.86);color:#fff;z-index:9999;flex-direction:column;padding:18px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #e6edf3;text-align:left;font-size:0.9rem}
  .timer{font-weight:700}
  .timer.red{color:#b91c1c}
  .hidden{display:none}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .muted-box{background:#f1f5f9;padding:6px 10px;border-radius:6px}
  footer{margin-top:12px;color:var(--muted);font-size:0.9rem}
  pre{white-space:pre-wrap;word-break:break-word}
  .btn-danger{background:#b91c1c}
  .readonly{background:#f8fafc}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <header>
      <div>
        <h1>Avaliação — Saúde e Segurança do Trabalho</h1>
        <div class="muted">Técnico em Automação Industrial — Duração: 1h30</div>
      </div>
      <div style="text-align:right">
        <div class="muted-box">Arquivo único — local</div>
      </div>
    </header>

    <nav>
      <button id="tabExam">Prova (Alunos)</button>
      <button id="tabAdmin">Painel (Professor)</button>
    </nav>

    <!-- EXAM -->
    <section id="examArea">
      <div class="card">
        <div class="row" style="align-items:center">
          <div class="col">
            <div class="small">Aluno (Nome completo) <span style="color:#b91c1c">*</span></div>
            <input id="studentName" placeholder="Ex: João da Silva" />
          </div>
          <div style="width:140px">
            <div class="small">Turma</div>
            <select id="studentClass"><option>1º B</option><option>1º F</option></select>
          </div>
          <div style="width:220px;text-align:right">
            <div class="small">Tempo restante</div>
            <div id="timer" class="timer">90:00</div>
          </div>
        </div>

        <p class="muted" style="margin-top:10px">
          Regras: clique em <strong>Iniciar</strong> para começar — esse clique ativa o contador e solicita tela cheia. Se você sair da aba/janela, será aplicada uma penalidade inicial de 30s que dobra a cada ausência subsequente. O contador ficará vermelho nos últimos 10 minutos.
        </p>

        <hr/>

        <form id="examForm">
          <div id="mcArea"></div>

          <h3>Questões dissertativas (21-30)</h3>
          <div id="discArea"></div>

          <div class="controls" style="margin-top:8px">
            <button id="startBtn" type="button">Iniciar (Tela cheia)</button>
            <button id="submitBtn" type="button">Enviar Avaliação</button>
            <button id="cancelExam" type="button">Cancelar</button>
          </div>
        </form>

        <div style="margin-top:12px">
          <div class="small">Logs recentes:</div>
          <pre id="logArea" style="height:110px;overflow:auto;background:#071126;color:#9fe6ff;padding:8px;border-radius:6px">Pronto.</pre>
        </div>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="adminArea" class="hidden">
      <div class="card">
        <h2>Painel do Professor</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <div><label>Senha:</label><input id="adminPw" type="password" /></div>
          <div><button id="adminLogin">Entrar</button></div>
          <div><button id="adminLogout" class="hidden">Sair</button></div>
        </div>

        <div id="adminMain" class="hidden" style="margin-top:12px">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div><strong>Professor:</strong> (acesso local)</div>
            <div style="display:flex;gap:8px">
              <button id="refreshData">Atualizar</button>
              <button id="exportCsv">Exportar CSV</button>
              <button id="clearData" class="btn-danger">Limpar dados</button>
            </div>
          </div>

          <div style="margin-top:12px;max-height:520px;overflow:auto">
            <table id="subsTable">
              <thead><tr><th>Aluno</th><th>Turma</th><th>Início</th><th>Penalidades</th><th>TempoRest(s)</th><th>Respostas</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:12px" class="small">
          Observação: as submissões ficam salvas no armazenamento local do navegador (localStorage). Exporte CSV para arquivar.
        </div>
      </div>
    </section>

    <footer class="muted" style="margin-top:10px">Mantenha backups exportando o CSV. Para maior segurança aplique supervisão presencial.</footer>
  </div>
</div>

<!-- Overlay penalidade -->
<div id="overlay">
  <h2>Penalidade aplicada</h2>
  <div id="overlayMsg">Você saiu da aba. Aguarde o tempo restante para retomar a avaliação.</div>
  <div id="countdown" style="font-size:2rem;margin-top:8px">30</div>
  <div class="small" style="margin-top:8px">Permaneça nesta tela até o contador zerar; depois a avaliação será liberada.</div>
</div>

<script>
/* ---------------- CONFIG ---------------- */
const ADMIN_PASSWORD = '159357';
const BASE_PENALTY = 30;
const MULTIPLIER = 2;
const MAX_PENALTY = 600;
const TOTAL_SECONDS = 90 * 60;
const STORAGE_KEY = 'avaliacao_sst_submissions_v2';

/* --------- UI references --------- */
const tabExam = document.getElementById('tabExam'), tabAdmin = document.getElementById('tabAdmin');
const examArea = document.getElementById('examArea'), adminArea = document.getElementById('adminArea');
const mcArea = document.getElementById('mcArea'), discArea = document.getElementById('discArea');
const startBtn = document.getElementById('startBtn'), submitBtn = document.getElementById('submitBtn');
const cancelExam = document.getElementById('cancelExam');
const timerEl = document.getElementById('timer'), logArea = document.getElementById('logArea');
const overlay = document.getElementById('overlay'), countdownEl = document.getElementById('countdown');

/* admin refs */
const adminPw = document.getElementById('adminPw'), adminLogin = document.getElementById('adminLogin'), adminLogout = document.getElementById('adminLogout');
const adminMain = document.getElementById('adminMain'), subsTableBody = document.querySelector('#subsTable tbody');
const refreshData = document.getElementById('refreshData'), exportCsv = document.getElementById('exportCsv'), clearData = document.getElementById('clearData');

/* tabs */
tabExam.onclick = ()=>{ examArea.classList.remove('hidden'); adminArea.classList.add('hidden'); }
tabAdmin.onclick = ()=>{ adminArea.classList.remove('hidden'); examArea.classList.add('hidden'); }

/* ---------- build questions ---------- */
const mcQuestions = [
  {q:'1) Qual a principal função da segurança do trabalho?', opts:['Reduzir custos a qualquer custo','Prevenir acidentes e proteger trabalhadores','Garantir horários de trabalho mais longos','Aumentar a quantidade de documentos financeiros']},
  {q:'2) Qual órgão é responsável pela publicação das NRs no Brasil?', opts:['Ministério do Trabalho e Previdência','INMETRO','ANVISA','IBAMA']},
  {q:'3) A análise estatística de acidentes serve para:', opts:['Identificar padrões e prevenir ocorrências','Somente justificar demissões','Substituir treinamentos por relatórios','Comprovante de pagamento de multas']},
  {q:'4) Qual item representa custo indireto de um acidente?', opts:['Conta hospitalar do trabalhador','Tempo de paralisação e perda de produtividade','Compra de um novo equipamento','Substituição de EPI avariado']},
  {q:'5) Um sistema preventivo de incêndio normalmente inclui:', opts:['Extintores, alarmes e rotas de fuga','Somente extintores','Apenas brigadeiros voluntários','Wi-Fi de alta velocidade']},
  {q:'6) Sobre EPI é correto afirmar:', opts:['Deve ser fornecido gratuitamente pela empresa e adequado ao risco','Pode ser compartilhado entre trabalhadores sem higienização','O trabalhador paga pelo EPI','É opcional em ambientes administrativos']},
  {q:'7) NR10 refere-se a:', opts:['Segurança em instalações e serviços em eletricidade','Proteção de máquinas','Gestão ambiental','Construções civis']},
  {q:'8) NR12 trata de:', opts:['Segurança no trabalho em máquinas e equipamentos','Exposição a agentes biológicos','Segurança em altura','Transporte rodoviário']},
  {q:'9) Riscos físicos incluem:', opts:['Ruído e vibração','Gasolina e solventes','Bactérias e vírus','Programas informaticos']},
  {q:'10) Riscos químicos envolvem:', opts:['Vapores, poeiras e gases','Temperaturas frias','Luz intensa','Barulho']},
  {q:'11) Proteção de máquinas deve:', opts:['Impedir acesso às partes móveis e ser segura para manutenção','Ser retirada sempre que possível','Ser apenas visual','Ser instalada apenas em máquinas novas']},
  {q:'12) Um programa de segurança bem aplicado pode:', opts:['Reduzir absenteísmo e custos com afastamentos','Aumentar horas extras','Diminuir o número de treinamentos','Substituir supervisão']},
  {q:'13) Custos diretos de um acidente normalmente NÃO incluem:', opts:['Perda de produtividade prolongada','Despesas médicas','Indenização e retrabalho','Reparo de equipamento danificado']},
  {q:'14) Um sinal de risco elétrico em um painel é:', opts:['Fiação exposta, cheiro de queimado, faíscas','Paredes limpas','Luzes indicadoras apagadas sem fumaça','Somente aumento de temperatura sem outros sinais']},
  {q:'15) Em caso de vazamento químico, a primeira ação correta é:', opts:['Isolar a área e advertir as pessoas próximas','Tentar neutralizar com água imediatamente','Ignorar e continuar o trabalho','Abrir janelas e sair sem avisar']},
  {q:'16) Treinamento geral deve ocorrer:', opts:['No início das atividades e sempre que houver mudança de processo','Apenas no primeiro dia de trabalho','Somente quando há acidentes','Apenas para gestores']},
  {q:'17) Para reduzir poluição em processos industriais deve-se:', opts:['Controlar emissões e tratar efluentes','Aumentar produção sem controles','Armazenar resíduos sem destino','Reduzir custos ignorando normas ambientais']},
  {q:'18) Energia e recursos minerais devem ser explorados:', opts:['Com licenciamento e práticas sustentáveis','Sem autorização quando necessário','Com prioridade ao lucro imediato','Apenas por grandes empresas']},
  {q:'19) Registro de eventos de segurança é importante porque:', opts:['Permite análise de causas e ações corretivas','Somente complica documentação','Serve só para processos trabalhistas','É irrelevante para empresas pequenas']},
  {q:'20) Em uma inspeção, prioridade imediata é:', opts:['Remover risco iminente e sinalizar o local','Preencher relatórios primeiro','Mudar o trabalhador de setor sem avaliar','Desligar toda a fábrica sem planejamento']}
];

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

mcQuestions.forEach((it, idx) => {
  const n = idx+1;
  const div = document.createElement('div'); div.className='q';
  const lbl = document.createElement('label'); lbl.innerText = it.q; div.appendChild(lbl);
  const opts = shuffle([...it.opts]);
  opts.forEach(opt => {
    const wrap = document.createElement('label');
    const inp = document.createElement('input');
    inp.type='radio'; inp.name='q'+n; inp.value=opt; inp.required=true;
    wrap.appendChild(inp); wrap.appendChild(document.createTextNode(' ' + opt));
    div.appendChild(wrap);
  });
  mcArea.appendChild(div);
});

/* dissertativas 21-30 */
const discPk = [
"21) Você é designado para trabalhar em um painel elétrico energizado. Cite 3 medidas imediatas e um EPI obrigatório e justifique.",
"22) Descreva um procedimento para identificação e correção de risco químico numa área de manutenção (3-5 passos).",
"23) Explique como um Programa de Segurança pode reduzir custos diretos e indiretos — dê 2 exemplos práticos.",
"24) Cite e explique 2 ações que a empresa pode tomar para evitar poluição/contaminação em um processo automatizado.",
"25) Em um acidente com máquina, qual seria a sequência imediata de ações até a chegada do serviço médico? Detalhe 4 passos.",
"26) Explique brevemente o que a NR12 exige para proteção de máquinas e uma medida que costuma ser negligenciada.",
"27) Como você instruiria um novo operador sobre uso correto de EPI para trabalhos em altura? (3 passos)",
"28) NR5410 (ABNT) trata de instalações elétricas. Dê um exemplo prático de como ela influencia uma planta automatizada.",
"29) No seu ver, qual o maior risco físico em uma linha de produção automatizada e qual a medida preventiva mais efetiva?",
"30) Cite duas ações práticas que mostram o compromisso da empresa com a segurança e a sustentabilidade ambiental."
];
discPk.forEach((txt,i)=>{
  const idx = 21+i;
  const d = document.createElement('div'); d.className='q';
  const lab = document.createElement('label'); lab.innerHTML = `<strong>${idx})</strong> ${txt}<textarea name="q${idx}" required></textarea>`;
  d.appendChild(lab); discArea.appendChild(d);
});

/* ---------------- Session & timer ---------------- */
let sessionId = sessionStorage.getItem('sessionId') || ('sess_'+Date.now().toString(36));
sessionStorage.setItem('sessionId', sessionId);
let penaltyCount = Number(sessionStorage.getItem('penaltyCount') || 0);
let remaining = Number(sessionStorage.getItem('remaining_seconds') || TOTAL_SECONDS);
let running = false;

function log(msg){ const ts = new Date().toLocaleTimeString(); logArea.textContent = `[${ts}] ${msg}\n` + logArea.textContent; }

/* Timer: always counts down (even if tab hidden) to avoid gaming */
function formatTime(s){ const m=Math.floor(s/60), sec = s%60; return String(m).padStart(2,'0')+':'+String(sec).padStart(2,'0'); }
timerEl.innerText = formatTime(remaining);
if(remaining <= 600) timerEl.classList.add('red');

let tickInterval = setInterval(()=>{
  if(running && remaining > 0){
    remaining--;
    sessionStorage.setItem('remaining_seconds', remaining);
    timerEl.innerText = formatTime(remaining);
    if(remaining <= 600) timerEl.classList.add('red');
    if(remaining <= 0){
      running = false;
      log('Tempo esgotado — enviando automaticamente.');
      autoSubmit();
    }
  }
}, 1000);

/* ---------- Visibility / Penalidade ---------- */
/* When document becomes hidden we just record the exit (penaltyCount++). When visible again we show overlay blocking for computed penalty seconds. */
document.addEventListener('visibilitychange', () => {
  if(document.hidden){
    // record exit time and increment count
    penaltyCount++;
    sessionStorage.setItem('penaltyCount', penaltyCount);
    log('Saída detectada (penaltyCount=' + penaltyCount + ')');
  } else {
    if(penaltyCount > 0){
      const secs = Math.min(MAX_PENALTY, Math.round(BASE_PENALTY * Math.pow(MULTIPLIER, Math.max(0, penaltyCount-1))));
      log('Retorno detectado — aplicando penalidade de ' + secs + 's');
      applyPenalty(secs);
    } else {
      log('Retornou à aba');
    }
  }
});

/* apply penalty: show overlay and pause interactions for seconds */
let penaltyActive = false;
function applyPenalty(seconds){
  if(penaltyActive) return;
  penaltyActive = true;
  overlay.style.display = 'flex';
  countdownEl.innerText = seconds;
  // stop interactions: set running false (timer continues but student can't interact)
  const prevRunning = running;
  running = false;
  let s = seconds;
  const t = setInterval(()=>{
    s--;
    countdownEl.innerText = s;
    if(s <= 0){
      clearInterval(t);
      overlay.style.display = 'none';
      penaltyActive = false;
      // allow interactions again
      running = prevRunning;
      log('Penalidade finalizada');
    }
  }, 1000);
}

/* ---------- Start button ---------- */
startBtn.addEventListener('click', async () => {
  const name = document.getElementById('studentName').value.trim();
  if(!name){ alert('Digite seu nome completo antes de iniciar.'); return; }
  // Request fullscreen (must be user gesture)
  try{
    await document.documentElement.requestFullscreen();
    log('Iniciou prova em tela cheia');
  }catch(e){
    log('Falha ao entrar em tela cheia: ' + e.message);
  }
  // reset penalty/session values for new run
  sessionStorage.setItem('penaltyCount', penaltyCount);
  if(!sessionStorage.getItem('remaining_seconds')) {
    remaining = TOTAL_SECONDS;
    sessionStorage.setItem('remaining_seconds', remaining);
  }
  running = true;
});

/* ---------- Submit (manual) ---------- */
submitBtn.addEventListener('click', () => {
  if(penaltyActive){ alert('Você está em penalidade. Aguarde antes de enviar.'); return; }
  if(!document.getElementById('studentName').value.trim()){ alert('Digite seu nome completo antes de enviar.'); return; }
  sendSubmission(false);
});

/* automatic submit when timer ends */
function autoSubmit(){
  if(penaltyActive){ setTimeout(autoSubmit, 2000); return; } // wait until penalty ends
  sendSubmission(true);
}

/* gather answers and save to localStorage */
function sendSubmission(isAuto){
  const name = document.getElementById('studentName').value.trim();
  const clas = document.getElementById('studentClass').value;
  // collect MC answers and disc answers
  const formEls = document.querySelectorAll('#mcArea input[type=radio], #discArea textarea, #mcArea input[type=radio]');
  // simpler: read using form fields by name
  const answers = {};
  for(let i=1;i<=20;i++){
    const v = document.querySelector('input[name="q'+i+'"]:checked');
    answers['q'+i] = v ? v.value : '';
  }
  for(let i=21;i<=30;i++){
    const ta = document.querySelector('textarea[name="q'+i+'"]');
    answers['q'+i] = ta ? ta.value.trim() : '';
  }
  const payload = {
    id: 'sub_' + Date.now().toString(36),
    sessionId,
    student: name,
    class: clas,
    ts: new Date().toISOString(),
    penaltyCount: penaltyCount,
    remaining: remaining,
    answers: answers,
    auto: !!isAuto
  };
  // save
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  arr.push(payload);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  log('Submissão salva localmente: ' + name + ' (penalidades=' + penaltyCount + ')');
  // reset session storage for next student
  sessionStorage.removeItem('penaltyCount');
  sessionStorage.removeItem('remaining_seconds');
  penaltyCount = 0;
  running = false;
  // show confirmation
  alert('Prova enviada com sucesso. Obrigado.');
  // exit fullscreen if possible
  try{ if(document.fullscreenElement) document.exitFullscreen(); }catch(e){}
}

/* cancel */
cancelExam.addEventListener('click', ()=>{ if(confirm('Cancelar a avaliação? Respostas não enviadas serão perdidas.')) location.reload(); });

/* ---------- Admin functions ---------- */
adminLogin.addEventListener('click', ()=>{
  if(adminPw.value === ADMIN_PASSWORD){
    adminPw.value = '';
    adminMain.classList.remove('hidden');
    adminLogout.classList.remove('hidden');
    adminLogin.classList.add('hidden');
    renderSubmissions();
  } else alert('Senha incorreta');
});
adminLogout.addEventListener('click', ()=>{
  adminMain.classList.add('hidden');
  adminLogout.classList.add('hidden');
  adminLogin.classList.remove('hidden');
});

/* render submissions */
function renderSubmissions(){
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  subsTableBody.innerHTML = '';
  arr.forEach(s=>{
    const tr = document.createElement('tr');
    const ans = JSON.stringify(s.answers);
    tr.innerHTML = `<td>${escapeHtml(s.student)}</td><td>${escapeHtml(s.class)}</td><td>${s.ts}</td><td>${s.penaltyCount||0}</td><td>${s.remaining||0}</td><td style="max-width:420px;white-space:pre-wrap">${escapeHtml(ans)}</td>`;
    subsTableBody.appendChild(tr);
  });
}

/* export CSV */
exportCsv.addEventListener('click', ()=>{
  const arr = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
  if(!arr.length){ alert('Nenhuma submissão para exportar.'); return; }
  const rows = arr.map(s=>{
    const answers = JSON.stringify(s.answers).replace(/"/g,'""');
    return `"${s.student}","${s.class}","${s.ts}","${s.penaltyCount || 0}","${s.remaining || 0}","${answers}"`;
  });
  const csv = 'Aluno,Turma,Início,Penalidades,TempoRest(s),Respostas\n' + rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'avaliacoes_sst_export.csv'; a.click(); URL.revokeObjectURL(url);
});

/* clear data */
clearData.addEventListener('click', ()=>{
  if(confirm('Apagar todas as submissões? Esta ação não tem volta.')){
    localStorage.removeItem(STORAGE_KEY);
    renderSubmissions();
    alert('Dados apagados.');
  }
});

refreshData.addEventListener('click', renderSubmissions);

/* helper escape */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]); }

/* initialize */
renderSubmissions();
log('Arquivo pronto. Clique em Iniciar para começar (senha professor: ' + ADMIN_PASSWORD + ').');
</script>
</body>
</html>
