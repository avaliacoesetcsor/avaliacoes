<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Avaliação SST — Arquivo Único</title>
<style>
  :root{--max-width:980px;--muted:#6b7280}
  body{font-family:Arial, Helvetica, sans-serif;background:#f4f6f8;color:#111;margin:0;padding:16px}
  .container{max-width:1100px;margin:0 auto}
  .card{background:#fff;border-radius:10px;padding:16px;box-shadow:0 6px 18px rgba(15,23,42,.06)}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:1.25rem}
  nav{margin:12px 0;display:flex;gap:8px}
  button{background:#0b74da;color:white;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
  .muted{color:var(--muted);font-size:0.95rem}
  input, textarea, select{padding:8px;border-radius:6px;border:1px solid #cbd5e1;width:100%;box-sizing:border-box}
  .row{display:flex;gap:12px}
  .col{flex:1}
  .q{padding:10px;border-radius:8px;background:#fbfdff;margin-bottom:10px;border:1px solid #eef2f7}
  label{display:block;margin-bottom:6px}
  .small{font-size:0.9rem;color:var(--muted)}
  #overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(2,6,23,.76);color:#fff;z-index:9999;flex-direction:column;padding:18px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #e6edf3;text-align:left;font-size:0.9rem}
  .danger{background:#b91c1c}
  .timer{font-weight:700}
  .timer.red{color:#b91c1c}
  .hidden{display:none}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  .muted-box{background:#f1f5f9;padding:6px 10px;border-radius:6px}
  footer{margin-top:12px;color:var(--muted);font-size:0.9rem}
  pre{white-space:pre-wrap;word-break:break-word}
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <header>
      <div>
        <h1>Avaliação — Saúde e Segurança do Trabalho</h1>
        <div class="muted">Curso: Técnico em Automação Industrial — Duração: 1h30</div>
      </div>
      <div style="text-align:right">
        <div class="muted">Sessão local</div>
        <div class="muted-box">Arquivo único (local)</div>
      </div>
    </header>

    <nav>
      <button id="tabExam">Prova (Alunos)</button>
      <button id="tabAdmin">Painel (Professor)</button>
    </nav>

    <!-- EXAM (Aluno) -->
    <section id="examArea" class="">
      <div class="card">
        <div class="row" style="align-items:center">
          <div class="col">
            <div class="small">Aluno (Nome completo) <span style="color:#b91c1c">*</span></div>
            <input id="studentName" placeholder="Ex: João da Silva" />
          </div>
          <div style="width:130px">
            <div class="small">Turma</div>
            <select id="studentClass">
              <option value="1º B">1º B</option>
              <option value="1º F">1º F</option>
            </select>
          </div>
          <div style="width:210px;text-align:right">
            <div class="small">Tempo restante</div>
            <div id="timer" class="timer">90:00</div>
          </div>
        </div>

        <p class="muted" style="margin-top:10px">
          Regras: entre em tela cheia para iniciar. Se você sair da aba (ou alternar janelas), será aplicada uma penalidade inicial de 30s, que dobra a cada ausência subsequente. O contador ficará vermelho nos últimos 10 minutos.
        </p>

        <hr/>

        <form id="examForm">
          <div id="mcArea"></div>

          <h3>Questões dissertativas</h3>
          <!-- 21-30 -->
          <div class="q"><label>21) Você é designado para trabalhar em um painel elétrico energizado. Cite 3 medidas imediatas e um EPI obrigatório e justifique.<textarea name="q21" required></textarea></label></div>
          <div class="q"><label>22) Descreva procedimento para identificação e correção de risco químico (3-5 passos).<textarea name="q22" required></textarea></label></div>
          <div class="q"><label>23) Como um Programa de Segurança reduz custos? Dê 2 exemplos.<textarea name="q23" required></textarea></label></div>
          <div class="q"><label>24) Cite 2 ações para evitar poluição em processo automatizado.<textarea name="q24" required></textarea></label></div>
          <div class="q"><label>25) Em um acidente com máquina, descreva 4 passos imediatos até atendimento.<textarea name="q25" required></textarea></label></div>
          <div class="q"><label>26) Explique brevemente o que a NR12 exige e uma medida negligenciada.<textarea name="q26" required></textarea></label></div>
          <div class="q"><label>27) Instruções a um novo operador sobre EPI para trabalhos em altura (3 passos).<textarea name="q27" required></textarea></label></div>
          <div class="q"><label>28) NR5410 — exemplo prático de influência numa planta automatizada.<textarea name="q28" required></textarea></label></div>
          <div class="q"><label>29) Maior risco físico em linha automatizada e medida preventiva.<textarea name="q29" required></textarea></label></div>
          <div class="q"><label>30) Cite duas ações que demonstram compromisso com segurança e sustentabilidade.<textarea name="q30" required></textarea></label></div>

          <div class="controls" style="margin-top:8px">
            <button id="startBtn" type="button">Iniciar (Tela cheia)</button>
            <button type="submit">Enviar Avaliação</button>
            <button id="cancelExam" type="button">Cancelar</button>
          </div>
        </form>

        <div style="margin-top:12px">
          <div class="small">Logs recentes:</div>
          <pre id="logArea" style="height:100px;overflow:auto;background:#071126;color:#9fe6ff;padding:8px;border-radius:6px">Pronto.</pre>
        </div>
      </div>
    </section>

    <!-- ADMIN (Professor) -->
    <section id="adminArea" class="hidden">
      <div class="card">
        <h2>Painel do Professor</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <div><label>Senha:</label><input id="adminPw" type="password" /></div>
          <div><button id="adminLogin">Entrar</button></div>
          <div><button id="adminLogout" class="hidden">Sair</button></div>
        </div>

        <div id="adminMain" class="hidden" style="margin-top:12px">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <div><strong>Professor:</strong> (acesso local)</div>
            <div style="display:flex;gap:8px">
              <button id="refreshData">Atualizar</button>
              <button id="exportCsv">Exportar CSV</button>
              <button id="clearData" style="background:#b91c1c">Limpar todos dados</button>
            </div>
          </div>

          <div style="margin-top:12px;max-height:520px;overflow:auto">
            <table id="subsTable">
              <thead><tr><th>Aluno</th><th>Turma</th><th>Início</th><th>Penalidades</th><th>TempoRest(s)</th><th>Respostas</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:12px" class="small">
          As submissões ficam salvas no navegador (localStorage). Para arquivar/exportar, use Exportar CSV.
        </div>
      </div>
    </section>

    <footer class="muted">Arquivo único — mantenha cópias de segurança do navegador (favor não limpar armazenamento se quiser preservar respostas).</footer>
  </div>
</div>

<!-- Overlay penalidade -->
<div id="overlay">
  <h2>Penalidade aplicada</h2>
  <div id="overlayMsg">Você saiu da aba. Aguarde o tempo restante para retomar a avaliação.</div>
  <div id="countdown" style="font-size:2rem;margin-top:8px">30</div>
  <div class="small" style="margin-top:8px">Permaneça nesta tela até o contador zerar; a prova será liberada automaticamente.</div>
</div>

<script>
/* ----------------- Config ----------------- */
const ADMIN_PASSWORD = '159357';
const BASE_PENALTY = 30; // segundos
const MULTIPLIER = 2;
const MAX_PENALTY = 600;
const TOTAL_SECONDS = 90 * 60; // 1h30
const SUBMISSIONS_KEY = 'avaliacao_sst_submissions_v1';
const SESSION_PREFIX = 'avaliacao_sst_session_';

/* --------- Tab switching --------- */
const tabExam = document.getElementById('tabExam');
const tabAdmin = document.getElementById('tabAdmin');
const examArea = document.getElementById('examArea');
const adminArea = document.getElementById('adminArea');

tabExam.addEventListener('click', ()=>{ examArea.classList.remove('hidden'); adminArea.classList.add('hidden'); });
tabAdmin.addEventListener('click', ()=>{ adminArea.classList.remove('hidden'); examArea.classList.add('hidden'); });

/* --------- Build MC questions and shuffle options --------- */
const mcQuestions = [
  {q:'1) Qual a principal função da segurança do trabalho?', opts:['Reduzir custos a qualquer custo','Prevenir acidentes e proteger trabalhadores','Garantir horários de trabalho mais longos','Aumentar a quantidade de documentos financeiros']},
  {q:'2) Qual órgão é responsável pela publicação das NRs no Brasil?', opts:['Ministério do Trabalho e Previdência','INMETRO','ANVISA','IBAMA']},
  {q:'3) A análise estatística de acidentes serve para:', opts:['Identificar padrões e prevenir ocorrências','Somente justificar demissões','Substituir treinamentos por relatórios','Comprovante de pagamento de multas']},
  {q:'4) Qual item representa custo indireto de um acidente?', opts:['Conta hospitalar do trabalhador','Tempo de paralisação e perda de produtividade','Compra de um novo equipamento','Substituição de EPI avariado']},
  {q:'5) Um sistema preventivo de incêndio normalmente inclui:', opts:['Extintores, alarmes e rotas de fuga','Somente extintores','Apenas brigadeiros voluntários','Wi-Fi de alta velocidade']},
  {q:'6) Sobre EPI é correto afirmar:', opts:['Deve ser fornecido gratuitamente pela empresa e adequado ao risco','Pode ser compartilhado entre trabalhadores sem higienização','O trabalhador paga pelo EPI','É opcional em ambientes administrativos']},
  {q:'7) NR10 refere-se a:', opts:['Segurança em instalações e serviços em eletricidade','Proteção de máquinas','Gestão ambiental','Construções civis']},
  {q:'8) NR12 trata de:', opts:['Segurança no trabalho em máquinas e equipamentos','Exposição a agentes biológicos','Segurança em altura','Transporte rodoviário']},
  {q:'9) Riscos físicos incluem:', opts:['Ruído e vibração','Gasolina e solventes','Bactérias e vírus','Programas informáticos']},
  {q:'10) Riscos químicos envolvem:', opts:['Vapores, poeiras e gases','Temperaturas frias','Luz intensa','Barulho']},
  {q:'11) Proteção de máquinas deve:', opts:['Impedir acesso às partes móveis e ser segura para manutenção','Ser retirada sempre que possível','Ser apenas visual','Ser instalada apenas em máquinas novas']},
  {q:'12) Um programa de segurança bem aplicado pode:', opts:['Reduzir absenteísmo e custos com afastamentos','Aumentar horas extras','Diminuir o número de treinamentos','Substituir supervisão']},
  {q:'13) Custos diretos de um acidente normalmente NÃO incluem:', opts:['Perda de produtividade prolongada','Despesas médicas','Indenização e retrabalho','Reparo de equipamento danificado']},
  {q:'14) Um sinal de risco elétrico em um painel é:', opts:['Fiação exposta, cheiro de queimado, faíscas','Paredes limpas','Luzes indicadoras apagadas sem fumaça','Somente aumento de temperatura sem outros sinais']},
  {q:'15) Em caso de vazamento químico, a primeira ação correta é:', opts:['Isolar a área e advertir as pessoas próximas','Tentar neutralizar com água imediatamente','Ignorar e continuar o trabalho','Abrir janelas e sair sem avisar']},
  {q:'16) Treinamento geral deve ocorrer:', opts:['No início das atividades e sempre que houver mudança de processo','Apenas no primeiro dia de trabalho','Somente quando há acidentes','Apenas para gestores']},
  {q:'17) Para reduzir poluição em processos industriais deve-se:', opts:['Controlar emissões e tratar efluentes','Aumentar produção sem controles','Armazenar resíduos sem destino','Reduzir custos ignorando normas ambientais']},
  {q:'18) Energia e recursos minerais devem ser explorados:', opts:['Com licenciamento e práticas sustentáveis','Sem autorização quando necessário','Com prioridade ao lucro imediato','Apenas por grandes empresas']},
  {q:'19) Registro de eventos de segurança é importante porque:', opts:['Permite análise de causas e ações corretivas','Somente complica documentação','Serve só para processos trabalhistas','É irrelevante para empresas pequenas']},
  {q:'20) Em uma inspeção, prioridade imediata é:', opts:['Remover risco iminente e sinalizar o local','Preencher relatórios primeiro','Mudar o trabalhador de setor sem avaliar','Desligar toda a fábrica sem planejamento']}
];

function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

const mcArea = document.getElementById('mcArea');
mcQuestions.forEach((item, idx) => {
  const n = idx + 1;
  const div = document.createElement('div'); div.className = 'q';
  const lbl = document.createElement('label'); lbl.innerText = item.q; div.appendChild(lbl);
  const opts = shuffle([...item.opts]);
  opts.forEach(opt => {
    const wrap = document.createElement('label');
    const inp = document.createElement('input'); inp.type='radio'; inp.name='q'+n; inp.value=opt; inp.required=true;
    wrap.appendChild(inp); wrap.appendChild(document.createTextNode(' ' + opt));
    div.appendChild(wrap);
  });
  mcArea.appendChild(div);
});

/* --------- Session, penalidade e timer --------- */
const logArea = document.getElementById('logArea');
const studentName = document.getElementById('studentName');
const studentClass = document.getElementById('studentClass');
const sessIdEl = document.getElementById('sessId');
let sessionId = sessionStorage.getItem('sessionId') || (SESSION_PREFIX + Date.now().toString(36));
sessionStorage.setItem('sessionId', sessionId);
sessIdEl.innerText = sessionId;

function log(msg){
  const ts = new Date().toLocaleTimeString();
  logArea.textContent = `[${ts}] ${msg}\n` + logArea.textContent;
}

let penaltyCount = Number(sessionStorage.getItem('penaltyCount') || 0);

function computePenalty(){
  return Math.min(MAX_PENALTY, Math.round(BASE_PENALTY * Math.pow(MULTIPLIER, Math.max(0, penaltyCount-1))));
}

function showPenaltyOverlay(seconds){
  const overlay = document.getElementById('overlay');
  const countdown = document.getElementById('countdown');
  overlay.style.display = 'flex';
  countdown.innerText = seconds;
  let s = seconds;
  const t = setInterval(() => {
    s--;
    countdown.innerText = s;
    if(s <= 0){
      clearInterval(t);
      overlay.style.display = 'none';
    }
  }, 1000);
}

/* detecta visibilidade */
document.addEventListener('visibilitychange', () => {
  if(document.hidden){
    penaltyCount++;
    sessionStorage.setItem('penaltyCount', penaltyCount);
    log('Aba ficou oculta (penaltyCount=' + penaltyCount + ')');
  } else {
    log('Retornou à aba');
    if(penaltyCount > 0){
      const sec = computePenalty();
      log('Aplicando penalidade: ' + sec + 's');
      showPenaltyOverlay(sec);
    }
  }
});

/* Fullscreen e iniciar */
document.getElementById('startBtn').addEventListener('click', async () => {
  if(!studentName.value.trim()){
    alert('Digite seu nome completo antes de iniciar.');
    return;
  }
  try{
    await document.documentElement.requestFullscreen();
    log('Entrou em tela cheia');
  }catch(e){
    log('Erro ao solicitar tela cheia: ' + e.message);
  }
});

/* Timer persistente em sessionStorage (apenas para a sessão do aluno) */
const timerEl = document.getElementById('timer');
let remaining = Number(sessionStorage.getItem('remaining_seconds')) || TOTAL_SECONDS;

function formatTime(s){
  const m = Math.floor(s/60), sec = s % 60;
  return String(m).padStart(2,'0') + ':' + String(sec).padStart(2,'0');
}

function tick(){
  if(remaining <= 0) return;
  remaining--;
  sessionStorage.setItem('remaining_seconds', remaining);
  timerEl.innerText = formatTime(remaining);
  if(remaining <= 600) timerEl.classList.add('red');
  if(remaining <= 0){
    alert('Tempo esgotado. A avaliação será enviada automaticamente.');
    submitExam(); // auto submit
  }
}
setInterval(()=>{ if(!document.hidden && remaining > 0) tick(); }, 1000);
timerEl.innerText = formatTime(remaining);
if(remaining <= 600) timerEl.classList.add('red');

/* ---------- Storage helpers (localStorage) ---------- */
function loadSubmissions(){
  const raw = localStorage.getItem(SUBMISSIONS_KEY);
  return raw ? JSON.parse(raw) : [];
}
function saveSubmission(obj){
  const arr = loadSubmissions();
  arr.push(obj);
  localStorage.setItem(SUBMISSIONS_KEY, JSON.stringify(arr));
}

/* ---------- Submit form ---------- */
const examForm = document.getElementById('examForm');
examForm.addEventListener('submit', (ev) => {
  ev.preventDefault();
  if(!studentName.value.trim()){
    alert('Digite seu nome completo antes de enviar.');
    return;
  }
  submitExam();
});

async function submitExam(){
  // gather answers
  const data = new FormData(examForm);
  const answers = {};
  for(const [k, v] of data.entries()) answers[k] = v;
  const payload = {
    sessionId,
    student: studentName.value.trim(),
    class: studentClass.value,
    ts: new Date().toISOString(),
    penaltyCount: penaltyCount,
    remaining: remaining,
    answers
  };
  saveSubmission(payload);
  log('Avaliação enviada localmente. Obrigado, ' + payload.student);
  // clear session keys for next student
  sessionStorage.removeItem('penaltyCount');
  sessionStorage.removeItem('remaining_seconds');
  // reset variables
  penaltyCount = 0;
  remaining = 0;
  timerEl.innerText = '00:00';
  alert('Avaliação enviada com sucesso.');
}

/* cancel */
document.getElementById('cancelExam').addEventListener('click', ()=>{
  if(confirm('Deseja cancelar a avaliação? As respostas não enviadas serão perdidas.')) location.reload();
});

/* ---------- Admin panel ---------- */
const adminLoginBtn = document.getElementById('adminLogin');
const adminLogoutBtn = document.getElementById('adminLogout');
const adminPw = document.getElementById('adminPw');
const adminMain = document.getElementById('adminMain');
const subsTableBody = document.querySelector('#subsTable tbody');
const refreshBtn = document.getElementById('refreshData');
const exportBtn = document.getElementById('exportCsv');
const clearBtn = document.getElementById('clearData');

adminLoginBtn.addEventListener('click', ()=>{
  const pw = adminPw.value;
  if(pw === ADMIN_PASSWORD){
    adminPw.value = '';
    adminLoginSuccess();
  } else alert('Senha incorreta');
});

adminLogoutBtn.addEventListener('click', ()=>{
  adminMain.classList.add('hidden');
  adminLogoutBtn.classList.add('hidden');
  adminLoginBtn.classList.remove('hidden');
});

function adminLoginSuccess(){
  adminMain.classList.remove('hidden');
  adminLogoutBtn.classList.remove('hidden');
  adminLoginBtn.classList.add('hidden');
  renderSubmissions();
}

refreshBtn.addEventListener('click', renderSubmissions);

function renderSubmissions(){
  const subs = loadSubmissions();
  subsTableBody.innerHTML = '';
  subs.forEach(s => {
    const tr = document.createElement('tr');
    const answersStr = JSON.stringify(s.answers);
    tr.innerHTML = `<td>${escapeHtml(s.student)}</td><td>${escapeHtml(s.class)}</td><td>${s.ts}</td><td>${s.penaltyCount||0}</td><td>${s.remaining||0}</td><td style="max-width:420px;white-space:pre-wrap">${escapeHtml(answersStr)}</td>`;
    subsTableBody.appendChild(tr);
  });
}

exportBtn.addEventListener('click', ()=>{
  const subs = loadSubmissions();
  if(!subs.length){ alert('Nenhuma submissão para exportar.'); return; }
  const rows = subs.map(s => {
    const answers = JSON.stringify(s.answers).replace(/"/g,'""');
    return `"${s.student}","${s.class}","${s.ts}","${s.penaltyCount || 0}","${s.remaining || 0}","${answers}"`;
  });
  const csv = 'Aluno,Turma,Início,Penalidades,TempoRest(s),Respostas\n' + rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'avaliacoes_sst_export.csv';
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

clearBtn.addEventListener('click', ()=>{
  if(confirm('Tem certeza que quer apagar todas as submissões? Esta ação não pode ser desfeita.')){
    localStorage.removeItem(SUBMISSIONS_KEY);
    renderSubmissions();
    alert('Dados apagados.');
  }
});

/* helper: escape html */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
}

/* utility: allow quick access to admin via keyboard (Ctrl+Shift+A) */
document.addEventListener('keydown', (e) => {
  if(e.ctrlKey && e.shiftKey && e.key.toLowerCase() === 'a'){
    tabAdmin.click();
    document.getElementById('adminPw').focus();
  }
});

/* initialize admin view if any submissions exist (keeps hidden until login) */
renderSubmissions();

/* initial log */
log('Aplicativo pronto. Salve este arquivo e abra localmente. Senha do professor: ' + ADMIN_PASSWORD);

/* end */
</script>
</body>
</html>
